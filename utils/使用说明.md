# GitHub字符串自动更新工具使用说明

## 工具概述

`auto_string_updater.js`是一个用于自动化从GitHub网站抓取字符串并更新翻译词典的工具。它可以定期运行，帮助维护者持续更新GitHub中文翻译词典，确保翻译覆盖最新的GitHub界面元素。

## 主要功能

- 自动从多个GitHub页面抓取新的UI字符串
- 使用JSDOM进行HTML解析，提取更精确的文本
- 智能分类字符串到不同的翻译模块
- 自动跳过已存在于翻译词典中的字符串
- 支持HTTP请求重试和超时处理
- 自动创建文件备份，确保数据安全
- 提供详细的调试日志和提取结果保存
- 自动更新脚本版本号
- 可选的Git自动提交功能
- 新增状态重置功能，解决工具卡住问题

## 安装依赖

在运行脚本之前，需要安装必要的依赖包：

```bash
npm install jsdom
```

## 配置说明

脚本中的配置项位于`CONFIG`对象中，可以根据需要进行调整：

```javascript
const CONFIG = {
    // 重试配置
    retry: {
        maxAttempts: 3,      // 最大重试次数
        delay: 1000,         // 重试延迟时间（毫秒）
        timeout: 30000       // 请求超时时间（毫秒）
    },
    // 调试配置
    debug: {
        enabled: true,       // 是否启用调试模式
        saveExtractedStrings: true,  // 是否保存提取的字符串
        saveHtmlPages: false         // 是否保存下载的HTML页面
    },
    // GitHub请求头
    headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)...',
        // 其他请求头...
        // 如果需要，可以在这里添加Cookie：'Cookie': 'your_github_cookie_here'
    }
};
```

### 配置说明：

1. **retry**：控制网络请求的重试行为
   - `maxAttempts`：网络请求失败时的最大重试次数
   - `delay`：每次重试之间的延迟时间（毫秒）
   - `timeout`：请求超时时间（毫秒）

2. **debug**：控制调试功能
   - `enabled`：是否启用调试模式
   - `saveExtractedStrings`：是否将提取的字符串保存到调试文件
   - `saveHtmlPages`：是否保存下载的完整HTML页面（可能会占用较多磁盘空间）

3. **headers**：HTTP请求头配置
   - `User-Agent`：模拟浏览器请求头
   - 其他标准HTTP头
   - 可选的`Cookie`：如果GitHub限制了未登录用户的访问，可以添加登录后的Cookie

## 要抓取的页面配置

脚本中定义了要抓取的GitHub页面列表：

```javascript
const GITHUB_PAGES = [
    'https://github.com/',
    'https://github.com/settings/profile',
    'https://github.com/settings/admin',
    'https://github.com/settings/accessibility',
    'https://github.com/settings/notifications',
    'https://github.com/search',
    'https://github.com/notifications',
    'https://github.com/features/codespaces',
    // 更多页面...
];
```

您可以根据需要添加或移除页面。

## 使用方法

### 通过Web界面使用

1. 启动服务器：
   ```bash
   node utils/server.js
   ```

2. 在浏览器中打开服务器显示的地址（通常是 http://localhost:3004）

3. 配置参数和要抓取的页面

4. 点击"开始抓取字符串"按钮运行工具

5. 查看实时日志和进度信息

6. 如果遇到工具卡住无法开始新任务的情况，可以点击"重置工具状态"按钮清除运行锁

### 命令行直接运行

在项目目录下直接运行脚本：

```bash
node utils/auto_string_updater.js
```

### 定期自动运行

可以通过Windows任务计划程序或Linux的cron任务设置定期运行脚本。

#### Windows系统：

1. 创建一个批处理文件（例如`run_auto_updater.bat`）：
   ```batch
   @echo off
   cd /d "e:\Dropbox\GitHub\GitHub_i18n"
   node auto_string_updater.js
   ```

2. 通过Windows任务计划程序，将此批处理文件设置为定期运行（例如每周一次）。

#### Linux/Mac系统：

使用cron任务设置定期运行：

```bash
# 编辑cron任务
crontab -e

# 添加每周运行一次的任务（例如每周一凌晨2点）
0 2 * * 1 cd /path/to/GitHub_i18n && node auto_string_updater.js
```

## 输出说明

脚本运行时会输出详细的日志信息，包括：

- 正在下载的页面URL
- 从每个页面提取的字符串数量
- 新发现的未翻译字符串数量
- 字符串添加到的模块信息
- 文件备份路径
- 调试文件保存路径
- 操作完成状态

## 调试功能

当启用调试模式时，脚本会在`debug`目录下保存以下信息：

- `extracted_strings_时间戳.txt`：包含所有提取的新字符串
- `页面URL_替换后的名称_extracted_strings.txt`：每个页面提取的字符串及其来源选择器

这些文件可以帮助您检查提取的字符串质量和来源。

## 注意事项

1. 由于GitHub可能有访问限制，建议不要过于频繁地运行脚本（建议每周或每月运行一次）

2. 如果遇到持续的连接超时问题，可以尝试：
   - 添加有效的GitHub登录Cookie到配置中
   - 增加重试次数和超时时间
   - 减少每次运行时抓取的页面数量

3. 脚本会自动将新字符串的翻译设置为"待翻译：原文本"，请在运行后手动完善这些翻译

4. 为了确保数据安全，脚本会在每次运行前创建源文件的备份

5. Git自动提交功能是可选的，如果不需要可以注释掉相关代码

## 常见问题解决

### 问题1：连接超时错误

**症状**：`connect ETIMEDOUT` 或 `下载页面超时`错误

**解决方案**：
- 检查网络连接
- 添加GitHub登录Cookie
- 增加重试次数和超时时间
- 减少并发请求数量

### 问题4：工具卡住无法开始新任务

**症状**：点击"开始抓取字符串"按钮没有反应，或显示"工具已经在运行中"但实际上没有任务在运行

**解决方案**：
- 点击Web界面上的"重置工具状态"按钮强制清除运行锁
- 确认对话框出现后，点击"确定"完成重置
- 重置后，工具状态将恢复为"就绪"，可以重新开始新任务

### 问题2：提取的字符串质量不高

**症状**：提取了很多不需要翻译的文本或重复的文本

**解决方案**：
- 调整`isValidString`函数中的过滤条件
- 更新`extractStrings`函数中的选择器列表
- 增加或修改模块分类函数

### 问题3：无法正确添加到翻译词典

**症状**：提取了字符串但未添加到正确的模块

**解决方案**：
- 检查模块名称是否与翻译文件中的模块名称一致
- 更新模块分类函数的关键词列表
- 检查正则表达式是否正确匹配模块位置

## 高级定制

### 添加新的页面

编辑`GITHUB_PAGES`数组，添加新的GitHub页面URL。

### 添加新的模块

1. 在`addStringsToDictionary`函数的`modules`对象中添加新的模块
2. 创建对应的分类函数（例如`isNewModuleString`）
3. 确保翻译文件中存在对应的模块

### 调整选择器

编辑`extractStrings`函数中的`selectors`数组，添加或修改CSS选择器以提高字符串提取的准确性。

## 版本更新记录

| 版本 | 更新内容 |
|------|---------|
| 1.0.0 | 初始版本，基本的字符串抓取和更新功能 |
| 1.1.0 | 添加了重试机制和超时处理 |
| 1.2.0 | 增加了模块分类功能 |
| 1.3.0 | 添加了调试功能和详细日志 |
| 1.4.0 | 增加了Git自动提交功能 |
| 1.5.0 | 优化了字符串过滤和提取逻辑 |
| 1.6.0 | 添加了工具状态重置功能，优化了进程管理逻辑，解决工具卡住问题

## 作者

SutChan