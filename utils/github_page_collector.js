// github_page_collector.js\n// 用于从GitHub网站收集主要页面URL并更新页面配置文件\n// 作者: SutChan\n// 版本: 1.8.16\n\nconst fs = require('fs').promises;\nconst path = require('path');\nconst { JSDOM } = require('jsdom');\nconst https = require('https');\n\n// 配置\nconst CONFIG = {\n  pagesFilePath: path.resolve(__dirname, 'api', 'pages.json'),\n  userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36',\n  httpTimeout: 30000,\n  maxRetries: 3,\n  retryDelay: 2000,\n  baseUrl: 'https://github.com'\n};\n\n/**\n * 统一日志处理函数\n */\nfunction log(level, message, details = null) {\n  let logMessage = `[${level.toUpperCase()}] ${message}`;\n  \n  if (details) {\n    if (details instanceof Error) {\n      logMessage += `\n错误详情: ${details.message}\n${details.stack}`;\n    } else if (typeof details === 'object') {\n      try {\n        logMessage += `\n详细信息: ${JSON.stringify(details, null, 2)}`;\n      } catch (e) {\n        logMessage += `\n详细信息: [对象序列化失败]`;\n      }\n    } else {\n      logMessage += `\n详细信息: ${details}`;\n    }\n  }\n  \n  if (level === 'error') {\n    console.error(logMessage);\n  } else {\n    console.log(logMessage);\n  }\n}\n\n/**\n * 下载网页内容\n */\nasync function downloadPage(url, retryCount = 0) {\n  try {\n    // 验证URL格式\n    try {\n      new URL(url);\n    } catch (e) {\n      throw new Error(`URL格式无效: ${url}`);\n    }\n\n    return new Promise((resolve, reject) => {\n      const options = {\n        headers: {\n          'User-Agent': CONFIG.userAgent\n        },\n        timeout: CONFIG.httpTimeout\n      };\n\n      const req = https.get(url, options, (res) => {\n        // 处理重定向\n        if (res.statusCode >= 300 && res.statusCode < 400 && res.headers.location) {\n          const redirectUrl = new URL(res.headers.location, url).href;\n          log('info', `重定向: ${url} -> ${redirectUrl}`);\n          req.destroy();\n          downloadPage(redirectUrl, retryCount).then(resolve).catch(reject);\n          return;\n        }\n\n        if (res.statusCode !== 200) {\n          const error = new Error(`请求失败: ${url}, 状态码: ${res.statusCode}`);\n          if (retryCount < CONFIG.maxRetries) {\n            log('info', `请求失败，${CONFIG.retryDelay}ms后重试 (${retryCount + 1}/${CONFIG.maxRetries})`);\n            req.destroy();\n            setTimeout(() => {\n              downloadPage(url, retryCount + 1).then(resolve).catch(reject);\n            }, CONFIG.retryDelay);\n          } else {\n            reject(error);\n          }\n          return;\n        }\n\n        const chunks = [];\n        res.on('data', (chunk) => chunks.push(chunk));\n        res.on('end', () => {\n          try {\n            const data = Buffer.concat(chunks).toString('utf8');\n            log('info', `成功下载 ${url}`);\n            resolve(data);\n          } catch (encodingError) {\n            reject(new Error(`解析响应内容失败: ${encodingError.message}`));\n          }\n        });\n      });\n\n      req.on('error', (e) => {\n        const error = new Error(`请求错误: ${url}, 错误: ${e.message}`);\n        if (retryCount < CONFIG.maxRetries) {\n          log('info', `请求错误，${CONFIG.retryDelay}ms后重试 (${retryCount + 1}/${CONFIG.maxRetries})`);\n          setTimeout(() => {\n            downloadPage(url, retryCount + 1).then(resolve).catch(reject);\n          }, CONFIG.retryDelay);\n        } else {\n          reject(error);\n        }\n      });\n\n      req.on('timeout', () => {\n        req.destroy();\n        const error = new Error(`请求超时: ${url} (${CONFIG.httpTimeout}ms)`);\n        if (retryCount < CONFIG.maxRetries) {\n          log('info', `请求超时，${CONFIG.retryDelay}ms后重试 (${retryCount + 1}/${CONFIG.maxRetries})`);\n          setTimeout(() => {\n            downloadPage(url, retryCount + 1).then(resolve).catch(reject);\n          }, CONFIG.retryDelay);\n        } else {\n          reject(error);\n        }\n      });\n    });\n  } catch (error) {\n    log('error', `下载页面时发生错误: ${url}`, error);\n    throw error;\n  }\n}\n\n/**\n * 从HTML中提取链接\n */\nfunction extractLinks(html, baseUrl) {\n  try {\n    const { window } = new JSDOM(html);\n    const document = window.document;\n    const links = new Set();\n    \n    // 提取所有a标签的链接\n    const aTags = document.querySelectorAll('a[href]');\n    aTags.forEach(tag => {\n      const href = tag.getAttribute('href');\n      if (href) {\n        try {\n          // 构建完整URL\n          const fullUrl = new URL(href, baseUrl).href;\n          // 只保留GitHub域名的链接\n          if (fullUrl.startsWith('https://github.com/')) {\n            links.add(fullUrl);\n          }\n        } catch (e) {\n          // 忽略无效URL\n        }\n      }\n    });\n    \n    window.close();\n    return Array.from(links);\n  } catch (error) {\n    log('error', `提取链接时发生错误: ${error.message}`, error);\n    return [];\n  }\n}\n\n/**\n * 分类页面并分配模块\n */\nfunction categorizePage(url) {\n  const pathname = new URL(url).pathname;\n  const pathParts = pathname.split('/').filter(Boolean);\n  \n  // 根据路径模式确定模块\n  if (pathname === '/') {\n    return { url, selector: 'body', module: 'global' };\n  } else if (pathname.startsWith('/settings')) {\n    return { url, selector: 'body', module: 'settings' };\n  } else if (pathname.startsWith('/notifications')) {\n    return { url, selector: 'body', module: 'notifications' };\n  } else if (pathname.startsWith('/search')) {\n    return { url, selector: 'body', module: 'search' };\n  } else if (pathname.startsWith('/explore')) {\n    return { url, selector: 'body', module: 'explore' };\n  } else if (pathname.startsWith('/codespaces')) {\n    return { url, selector: 'body', module: 'codespaces' };\n  } else if (pathname.startsWith('/pulls')) {\n    return { url, selector: 'body', module: 'pullRequests' };\n  } else if (pathname.startsWith('/issues')) {\n    return { url, selector: 'body', module: 'issues' };\n  } else if (pathname.startsWith('/actions')) {\n    return { url, selector: 'body', module: 'actions' };\n  } else if (pathname.startsWith('/security')) {\n    return { url, selector: 'body', module: 'security' };\n  } else if (pathname.startsWith('/projects')) {\n    return { url, selector: 'body', module: 'projects' };\n  } else if (pathname.startsWith('/marketplace')) {\n    return { url, selector: 'body', module: 'marketplace' };\n  } else if (pathParts.length >= 2 && !pathParts[1].includes('.')) {\n    // 识别仓库页面，但排除文件路径\n    if (pathParts.length === 2 || \n        (pathParts.length === 3 && ['issues', 'pulls', 'actions', 'wiki', 'pulse', 'settings'].includes(pathParts[2]))) {\n      return { url, selector: 'body', module: 'repository' };\n    }\n  }\n  \n  // 默认使用全局模块\n  return { url, selector: 'body', module: 'global' };\n}\n\n/**\n * 过滤有效页面\n */\nfunction filterValidPages(links) {\n  const validPages = new Set();\n  const fileExtensions = ['.js', '.css', '.png', '.jpg', '.jpeg', '.gif', '.svg', '.ico', '.json', '.xml'];\n  \n  links.forEach(link => {\n    // 排除包含查询参数和锚点的URL，只保留基础路径\n    const url = new URL(link);\n    const pathname = url.pathname;\n    \n    // 跳过API路径和文件路径\n    if (pathname.includes('/api/') || \n        fileExtensions.some(ext => pathname.endsWith(ext)) ||\n        pathname.includes('/raw/') ||\n        pathname.includes('/login') ||\n        pathname.includes('/signup') ||\n        pathname.includes('/logout')) {\n      return;\n    }\n    \n    // 构建基础URL（不包含查询参数和锚点）\n    const baseUrl = `${url.origin}${pathname}`;\n    validPages.add(baseUrl);\n  });\n  \n  return Array.from(validPages);\n}\n\n/**\n * 加载现有的页面配置\n */\nasync function loadExistingPages() {\n  try {\n    const pagesData = await fs.readFile(CONFIG.pagesFilePath, 'utf8');\n    const pages = JSON.parse(pagesData);\n    if (Array.isArray(pages)) {\n      log('info', `已加载 ${pages.length} 个现有页面配置`);\n      return pages;\n    } else {\n      throw new Error('pages.json 格式错误，应为数组');\n    }\n  } catch (error) {\n    log('error', `加载现有页面配置失败: ${error.message}`);\n    log('info', '使用空的页面配置列表');\n    return [];\n  }\n}\n\n/**\n * 保存页面配置到文件\n */\nasync function savePagesToFile(pages) {\n  try {\n    // 确保目录存在\n    const dir = path.dirname(CONFIG.pagesFilePath);\n    await fs.mkdir(dir, { recursive: true });\n    \n    // 保存文件\n    await fs.writeFile(CONFIG.pagesFilePath, JSON.stringify(pages, null, 2), 'utf8');\n    log('info', `已保存 ${pages.length} 个页面配置到 ${CONFIG.pagesFilePath}`);\n  } catch (error) {\n    log('error', `保存页面配置失败: ${error.message}`, error);\n    throw error;\n  }\n}\n\n/**\n * 主函数\n */\nasync function main() {\n  log('info', 'GitHub页面收集器启动');\n  \n  try {\n    // 1. 加载现有的页面配置\n    const existingPages = await loadExistingPages();\n    const existingUrls = new Set(existingPages.map(page => page.url));\n    \n    // 2. 从GitHub首页开始收集链接\n    const html = await downloadPage(CONFIG.baseUrl);\n    let allLinks = extractLinks(html, CONFIG.baseUrl);\n    \n    // 3. 过滤出有效的GitHub页面\n    const validPages = filterValidPages(allLinks);\n    log('info', `从首页提取了 ${validPages.length} 个有效页面链接`);\n    \n    // 4. 为每个页面分配模块并去重\n    const newPages = [];\n    validPages.forEach(url => {\n      if (!existingUrls.has(url)) {\n        const categorizedPage = categorizePage(url);\n        newPages.push(categorizedPage);\n        existingUrls.add(url); // 避免重复添加\n      }\n    });\n    \n    // 5. 添加一些手动定义的重要页面\n    const importantPages = [\n      { url: 'https://github.com/settings/profile', selector: 'body', module: 'settings' },\n      { url: 'https://github.com/settings/account', selector: 'body', module: 'settings' },\n      { url: 'https://github.com/settings/repositories', selector: 'body', module: 'settings' },\n      { url: 'https://github.com/settings/billing', selector: 'body', module: 'settings' },\n      { url: 'https://github.com/settings/apps', selector: 'body', module: 'settings' },\n      { url: 'https://github.com/settings/keys', selector: 'body', module: 'settings' },\n      { url: 'https://github.com/notifications', selector: 'body', module: 'notifications' },\n      { url: 'https://github.com/notifications/unread', selector: 'body', module: 'notifications' },\n      { url: 'https://github.com/pulls', selector: 'body', module: 'pullRequests' },\n      { url: 'https://github.com/pulls/review-requested', selector: 'body', module: 'pullRequests' },\n      { url: 'https://github.com/issues', selector: 'body', module: 'issues' },\n      { url: 'https://github.com/issues/assigned', selector: 'body', module: 'issues' },\n      { url: 'https://github.com/explore', selector: 'body', module: 'explore' },\n      { url: 'https://github.com/trending', selector: 'body', module: 'explore' },\n      { url: 'https://github.com/collections', selector: 'body', module: 'explore' },\n      { url: 'https://github.com/marketplace', selector: 'body', module: 'marketplace' },\n      { url: 'https://github.com/marketplace/stars', selector: 'body', module: 'marketplace' },\n      { url: 'https://github.com/codespaces', selector: 'body', module: 'codespaces' },\n      { url: 'https://github.com/codespaces/new', selector: 'body', module: 'codespaces' },\n      { url: 'https://github.com/actions', selector: 'body', module: 'actions' },\n      { url: 'https://github.com/security', selector: 'body', module: 'security' },\n      { url: 'https://github.com/projects', selector: 'body', module: 'projects' },\n      { url: 'https://github.com/search', selector: 'body', module: 'search' },\n      { url: 'https://github.com/search/advanced', selector: 'body', module: 'search' },\n      { url: 'https://github.com/orgs/github/repositories', selector: 'body', module: 'repository' },\n      { url: 'https://github.com/github/github', selector: 'body', module: 'repository' },\n      { url: 'https://github.com/github/github/issues', selector: 'body', module: 'repository' },\n      { url: 'https://github.com/github/github/pulls', selector: 'body', module: 'repository' }\n    ];\n    \n    importantPages.forEach(page => {\n      if (!existingUrls.has(page.url)) {\n        newPages.push(page);\n        existingUrls.add(page.url);\n      }\n    });\n    \n    // 6. 合并新旧页面配置\n    const updatedPages = [...existingPages, ...newPages];\n    \n    // 7. 保存更新后的页面配置\n    if (newPages.length > 0) {\n      log('info', `发现并添加了 ${newPages.length} 个新页面配置`);\n      await savePagesToFile(updatedPages);\n    } else {\n      log('info', '没有发现新的页面配置，pages.json已是最新');\n    }\n    \n    // 8. 生成报告\n    log('info', 'GitHub页面收集完成！');\n    log('info', `总计收集了 ${updatedPages.length} 个GitHub页面配置`);\n    log('info', `现有页面: ${existingPages.length} 个`);\n    log('info', `新增页面: ${newPages.length} 个`);\n    \n    // 按模块统计\n    const modules = {};\n    updatedPages.forEach(page => {\n      if (!modules[page.module]) {\n        modules[page.module] = 0;\n      }\n      modules[page.module]++;\n    });\n    log('info', '按模块统计的页面数量:');\n    Object.entries(modules).forEach(([module, count]) => {\n      log('info', `  ${module}: ${count} 个页面`);\n    });\n    \n  } catch (error) {\n    log('error', 'GitHub页面收集失败:', error);\n    process.exit(1);\n  }\n}\n\n// 执行主函数\nmain().catch(err => {\n  log('error', '程序执行出错:', err);\n  process.exit(1);\n});